---
title: "第2章 — Dispatcher基礎架構"
description: 瞭解發佈和調度程式拓撲。 瞭解最常見的拓撲和設定。
feature: Dispatcher
topic: Architecture
role: Architect
level: Beginner
exl-id: a25b6f74-3686-40a9-a148-4dcafeda032f
source-git-commit: 4b47daf82e27f6bea4be30e3cdd132f497f4c609
workflow-type: tm+mt
source-wordcount: '1864'
ht-degree: 0%

---

# 第二章 — 基礎設施

## 設定快取基礎架構

在本系列第1章中，我們介紹了Publish系統和調度器的基本拓撲。 一組發佈伺服器和調度伺服器可以配置為多種變體，具體取決於預期負載、資料中心的拓撲和所需的故障切換屬性。

我們將描述最常見的拓撲，並描述其優勢和不足之處。 當然，這份清單永遠不可能是全面的。 唯一的限制是你的想像力。

### 「舊版」設定

在早期，潛在訪問者的數量很少，硬體價格昂貴，而且Web伺服器不像現在這樣被視為業務關鍵型。 常見的設定是在兩個或多個發佈系統之前讓一個Dispatcher充當負載平衡器和快取。 Dispatcher核心的Apache伺服器非常穩定，而且在大多數情況下，能夠滿足相當數量的請求。

![「舊版」Dispatcher設定 — 按照當今標準，不太常見](assets/chapter-2/legacy-dispatcher-setup.png)

*「舊版」Dispatcher設定 — 按照當今標準，不太常見*

<br> 

這是調度程式從以下位置接收其名稱的位置：它基本上是在發送請求。 此設定不再常見，因為它無法滿足當前要求的更高效能和穩定性要求。

### 多腿設定

現在，稍有不同的拓撲更為常見。 多條腿的拓撲每個發佈伺服器將有一個Dispatcher。 專用（硬體）負載平衡器位於基礎架構AEM前面，將請求分派到以下兩條（或更多條）腿：

![現代「標準」Dispatcher設定 — 易於處理和維護](assets/chapter-2/modern-standard-dispatcher-setup.png)

*現代「標準」Dispatcher設定 — 易於處理和維護*

<br> 

這是這種設定的原因，

1. 平均而言，網站提供的流量比過去多得多。 因此，有必要擴大&quot;阿帕奇基礎設施&quot;。

2. 「舊版」安裝程式未在Dispatcher級別提供冗餘。 如果Apache Server關閉，則無法訪問整個網站。

3. Apache Servers便宜。 它們基於開放原始碼，而且，如果您擁有虛擬資料中心，則可以非常快地配置它們。

4. 此設定為「滾動」或「交錯」更新方案提供了簡單的方法。 在發佈1上安裝新軟體包時，您只需關閉Dispatcher 1。 安裝完成後，您已從內部網路中對Publish 1進行了充分的煙霧測試，清除Dispatcher 1上的快取，然後重新啟動它，同時關閉Dispatcher 2以維護Publish 2。

5. 在此設定中，快取失效變得非常容易且確定。 由於只有一個發佈系統連接到一個調度程式，因此只有一個調度程式要失效。 失效的順序和時間是微不足道的。

### 「橫向擴展」設定

Apache Server價格低廉，易於配置，為什麼不進一步擴展該級別。 為什麼每個發佈伺服器前面沒有兩個或更多調度程式？

![「橫向擴展」設定 — 有一些應用領域，但也有限制和注意事項](assets/chapter-2/scale-out-setup.png)

*「橫向擴展」設定 — 有一些應用領域，但也有限制和注意事項*

<br> 

你絕對可以！ 而且該設定有許多有效的應用程式方案。 但是，您也應該考慮一些局限性和複雜性。

#### 無效

每個發佈系統連接到多個調度程式，當內容被更改時，每個調度程式必須失效。

#### 維護

不言而喻， Dispatcher和Publish系統的初始配置要複雜一些。 但同時也要記住，「滾動」釋放的努力也要高一些。 運行AEM時，系統可以且必須更新。 但明智的做法是，在它們積極服務請求時不這樣做。 通常，您只想更新發佈系統的一部分，而其他系統仍在主動為通信服務，然後在測試後切換到其他部分。 如果您運氣好，並且可以在部署過程中訪問負載平衡器，則可以禁用到此處維護的伺服器的路由。 如果您位於沒有直接訪問權限的共用負載平衡器上，則寧可關閉要更新的發佈的調度程式。 越多，你就越得關閉。 如果有大量資料，並且您計畫頻繁更新，則建議進行一些自動化。 如果沒有自動化工具，那麼擴展是個壞主意。

在過去的項目中，我們使用了另一種技巧從負載平衡中刪除發佈系統，而不直接訪問負載平衡器本身。

負載平衡器通常是「ping」，這是一個特定頁，用於查看伺服器是否已啟動並正在運行。 通常一個簡單的選擇是ping首頁。 但是，如果您希望使用ping向負載平衡器發出信號，而不是平衡流量，您會選擇其他選項。 您可以建立專用模板或Servlet，該模板或Servlet可配置為 `"up"` 或 `"down"` （在正文中或作為http響應代碼）。 當然，該頁的響應不能快取到調度程式中，因此它始終是從發佈系統中新獲取的。 現在，如果配置負載平衡器以檢查此模板或Servlet，則可以輕鬆讓「發佈」「假裝」關閉。 它不是負載平衡的一部分，可以更新。

#### 全球分銷

「全球分發」是「橫向擴展」設定，在每個發佈系統前都有多個派單程式，現在分佈於全球各地，以便更貼近客戶並提供更好的效能。 當然，在這種情況下，您沒有中央負載平衡器，而是使用基於DNS和geo-IP的負載平衡方案。

>[!NOTE]
>
>實際上，您正在使用此方法構建某種內容分發網路(CDN) — 因此您應考慮購買現成的CDN解決方案，而不是自己構建。 構建和維護自定義CDN並非易事。

#### 水準縮放

即使在本地資料中心中，每個發佈系統前面有多個調度程式的「向外擴展」拓撲也具有一些優勢。 如果您看到Apache伺服器上由於流量高（快取命中率良好）而出現效能瓶頸，並且無法再擴展硬體（通過添加CPU、RAM和更快的磁碟），則可以通過添加調度程式來提高效能。 這稱為「水準縮放」。 但是，這是有限制的，尤其是當您經常使通信無效時。 我們將在下一節中描述其效果。

#### 向外擴展拓撲的限制

添加代理伺服器通常應會提高效能。 但是，有些情況下，添加伺服器實際上會降低效能。 怎麼弄？ 假設你有一個新聞門戶，你每分鐘都會在這裡介紹新文章和新頁面。 Dispatcher因「自動失效」而失效：每當發佈頁面時，同一站點上快取中的所有頁面都將失效。 這是一個有用的功能 — 我們在 [第一章](chapter-1.md) 但這也意味著，當您的網站經常發生更改時，您會經常使快取失效。 如果每個發佈實例只有一個Dispatcher，則請求頁面的第一個訪問者將觸發該頁面的重新快取。 第二個訪問者已獲取快取的版本。

如果您有兩個調度程式，第二個訪問者有50%的機會不快取該頁，然後當再次呈現該頁面時，他會遇到更大的延遲。 每次發佈更多調度程式會讓情況更糟。 發佈伺服器會收到更多負載，因為它必須分別為每個Dispatcher重新呈現頁面。

![在頻繁快取刷新的橫向擴展情形中效能下降。](assets/chapter-2/decreased-performance.png)

*在頻繁快取刷新的橫向擴展情形中效能下降。*

<br> 

#### 減輕過度擴展問題

您可以考慮為所有調度程式使用中央共用儲存，或同步Apache伺服器的檔案系統以緩解問題。 我們只能提供有限的第一手經驗，但要準備好，這會增加系統的複雜性，並會引入一類全新的錯誤。

我們在NFS上做了一些實驗，但NFS由於內容鎖定而帶來了巨大的效能問題。 這實際上降低了整體效能。

**結論**  — 建議不要在多個調度程式之間共用一個通用檔案系統。

如果您面臨效能問題，請同樣擴展「發佈」和「調度程式」，以避免Publisher實例的峰值負載。 「發佈/調度器」比率沒有黃金規則 — 它高度取決於請求的分佈以及發佈和快取失效的頻率。

如果您還擔心訪問者的延遲，請考慮使用內容傳遞網路、快取重取、搶佔式快取預熱，設定寬限期，如中所述 [第一章](chapter-1.md) 或參考了 [第3部分](chapter-3.md)。

### 「交叉連接」設定

我們時不時看到的另一個設定是「交叉連接」設定：發佈實例沒有專用的調度程式，但所有調度程式都連接到所有發佈系統。

![交叉連接拓撲：增加冗餘和更複雜](assets/chapter-2/cross-connected-setup.png)

<br> 

*交叉連接拓撲：增加冗餘和更複雜。*

乍一看，這為相對較小的預算提供了一些更多冗餘。 當其中一台Apache伺服器關閉時，您仍可以使用兩個Publish系統來執行呈現工作。 此外，如果其中一個發佈系統崩潰，您仍有兩個調度程式為快取負載提供服務。

但這是有代價的。

首先，取一條腿進行維修比較麻煩。 實際上，這就是這個計畫的目的。更有彈性，保持運轉。 我們看到，如何處理這些問題的維護計畫很複雜。 首先重新配置Dispatcher 2，刪除交叉連接。 正在重新啟動Dispatcher 2。 正在關閉Dispatcher 1、更新發佈1、...等等。 如果它能長到兩條以上，你應該仔細考慮。 你會得出這樣的結論：它實際上增加了複雜性，增加了成本，並且是人類錯誤的一個可怕的來源。 最好是自動化。 所以最好檢查一下，如果你確實有人力資源可以將這個自動化任務納入到你的項目計畫中。 雖然您可以通過此節省一些硬體成本，但在IT員工方面卻可能花費一倍。

其次，您可能在需要登錄的上運行AEM一些用戶應用程式。 您使用粘滯會話，以確保始終從同一實例中為一個用戶提供服務AEM，以便您可以在該實例上維護會話狀態。 在進行此交叉連接設定後，必須確保在負載平衡器和調度程式上的粘滯會話正常工作。 並非不可能，但您需要瞭解這一點，並添加一些額外的配置和測試時間，這可能會降低您通過節省硬體而計畫的成本。

### 結論

我們不會建議您將此交叉連接方案用作預設選項。 但是，如果您決定使用它，您將希望仔細評估風險和隱藏成本，並計畫將配置自動化作為項目的一部分。

## 下一步

* [3 — 高級快取主題](chapter-3.md)
