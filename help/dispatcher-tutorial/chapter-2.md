---
title: 「第2章 — Dispatcher基礎結構」
description: 瞭解發佈和Dispatcher拓撲。 瞭解最常見的拓撲和設定。
feature: Dispatcher
topic: Architecture
role: Architect
level: Beginner
exl-id: a25b6f74-3686-40a9-a148-4dcafeda032f
source-git-commit: 4b47daf82e27f6bea4be30e3cdd132f497f4c609
workflow-type: tm+mt
source-wordcount: '1864'
ht-degree: 0%

---

# 第2章 — 基礎結構

## 設定快取基礎結構

在本系列的第1章中，我們介紹了Publish系統和Dispatcher的基本拓撲。 一組發佈和Dispatcher伺服器可設定成許多變化 — 取決於預期的負載、資料中心的拓撲和所需的容錯移轉屬性。

我們將草擬最常見的拓撲，並描述優點及不足之處。 當然，這份清單永遠都不可能完整。 唯一的限制是您的想像力。

### 「舊版」設定

在早期，潛在訪客人數不多，硬體價格昂貴，而且網頁伺服器並不像現在這樣被視為業務關鍵型伺服器。 常見的設定是在兩個或多個發佈系統前，讓一個Dispatcher作為負載平衡器和快取。 Dispatcher核心的Apache伺服器非常穩定，且在大部分設定中都能滿足適當數量的請求。

![「舊版」Dispatcher設定 — 以今天的標準來看不太常見](assets/chapter-2/legacy-dispatcher-setup.png)

*「舊版」Dispatcher設定 — 以今天的標準來看不太常見*

<br> 

這是Dispatcher從收到其名稱的位置：基本上是在傳送請求。 此設定已不再很常見，因為它無法滿足現今對效能和穩定性的更高要求。

### 多腿設定

現今稍有不同的拓撲比較常見。 多足拓撲的每個發佈伺服器會有一個Dispatcher。 專用的（硬體）負載平衡器位於AEM基礎架構的前面，將請求排程到以下兩個（或更多）分支：

![現代「標準」Dispatcher設定 — 易於處理和維護](assets/chapter-2/modern-standard-dispatcher-setup.png)

*現代「標準」Dispatcher設定 — 易於處理和維護*

<br> 

以下是這類設定的原因，

1. 網站平均提供的流量比過去多得多。 因此，需要擴展「Apache基礎結構」。

2. 「舊版」設定未在Dispatcher層級提供備援。 如果Apache Server發生問題，則無法連線整個網站。

3. Apache伺服器價格便宜。 這些服務是以開放原始碼為基礎，而且只要您擁有虛擬資料中心，就能快速完成布建。

4. 此設定可讓您輕鬆進行「滾動」或「交錯」更新案例。 只要在Publish 1上安裝新軟體套件時關閉Dispatcher 1即可。 當安裝完成時，且您已從內部網路經過充分煙霧測試的Publish 1，您會清除Dispatcher 1上的快取，然後重新啟動，同時關閉Dispatcher 2以維護Publish 2。

5. 在此設定中，快取失效變得非常容易且具有確定性。 由於只有一個Publish系統連線到一個Dispatcher，因此只有一個Dispatcher要失效。 失效的順序和時機微不足道。

### 「向外擴展」設定

Apache Server價格低廉且易於布建，何不進一步推出該層級的擴充功能。 為何每個Publish伺服器前面沒有兩個或更多Dispatcher？

![「向外擴展」設定 — 有一些應用程式領域，但也有限制和注意事項](assets/chapter-2/scale-out-setup.png)

*「向外擴展」設定 — 有一些應用程式領域，但也有限制和注意事項*

<br> 

您絕對可以這樣做！ 而且有許多適用於該設定的有效應用情境。 但也有一些限制和複雜性值得考慮。

#### 失效

每個Publish系統都會連線至多個Dispatcher，每個都會在內容變更時失效。

#### 維護

不言而喻，Dispatcher和Publish系統的初始設定更加複雜。 但也請記住，「滾動」版本的工作量也更高。 AEM系統在執行時可以而且必須更新。 但是明智的做法是在他們主動處理請求時不要這麼做。 通常，您只想更新發佈系統的一部分 — 而其他系統仍主動提供流量，然後 — 在測試後 — 切換到其他部分。 如果您很幸運，而且可以在部署過程中存取負載平衡器，您可以在此處停用維護中伺服器的路由。 如果您在共用負載平衡器上沒有直接存取權，您寧可關閉要更新之Publish的Dispatcher。 位置愈多，您必須關機的次數就愈多。 如果數量很大並且您計畫經常更新，建議使用一些自動化功能。 如果您沒有自動化工具，繼續擴充是不好的主意。

在過去的專案中，我們使用不同的秘訣從負載平衡中移除發佈系統，而不需要直接存取負載平衡器本身。

負載平衡器通常會「ping」，這是檢視伺服器是否已啟動且執行中的特定頁面。 一個簡單的選擇通常是Ping首頁。 但如果您想使用ping來表示負載平衡器不要平衡流量，您可以選擇其他選項。 您可以建立專用範本或servlet，將其設定為回應於 `"up"` 或 `"down"` （在內文中或當作http回應代碼）。 該頁面的回應當然不可在Dispatcher中快取，因此它一律會從Publish系統重新擷取。 現在，如果您設定負載平衡器來檢查此範本或servlet，您可以輕鬆讓發佈「假裝」它停止運作。 它不會成為負載平衡的一部分，而且可以更新。

#### 全球分佈

「全球發佈」是一種「向外擴展」設定，您在每個Publish系統前有多個Dispatcher — 現在分佈在世界各地，以便更接近客戶並提供更好的效能。 當然，在這種情況下，您沒有中央負載平衡器，而是基於DNS和地理IP的負載平衡配置。

>[!NOTE]
>
>實際上，您就是用這種方法建立某種內容發佈網路(CDN) — 因此您應該考慮購買現成的CDN解決方案，而不是自己建立解決方案。 建立及維護自訂CDN並非易事。

#### 水平縮放

即使是在本機資料中心，在每個發佈系統前面有多個Dispatcher的「向外擴展」拓撲也有一些優點。 如果您看到由於高流量（和良好的快取命中率）而導致Apache伺服器出現效能瓶頸，而且您無法再擴充硬體（藉由新增CPU、RAM和更快的磁碟），您可以藉由新增Dispatcher來提升效能。 這稱為「水平縮放」。 但是，這有限制，尤其是當您經常讓流量失效時。 我們將在下一節中說明此效果。

#### 向外擴展拓朴的限制

新增Proxy伺服器通常應該會提高效能。 但是，在某些情況下，新增伺服器可能會實際降低效能。 如何進行？ 假設您有一個新聞入口網站，您每分鐘都會在此介紹新文章和頁面。 Dispatcher會透過「自動失效」來失效：每當發佈頁面時，相同網站上的快取中的所有頁面都會失效。 這是一個有用的功能 — 我們在 [第1章](chapter-1.md) 此系列中 — 但這也意味著，當您的網站經常發生變更時，您經常會使快取失效。 如果您每個發佈執行個體只有一個Dispatcher，則第一個訪客請求頁面時會觸發該頁面的重新快取。 第二個訪客已取得快取版本。

如果您有兩個Dispatcher，則第二個訪客有50%的機會不會快取頁面，然後再次轉譯該頁面時，他會遇到較大的延遲。 每個Publish擁有更多的Dispatcher會讓事情變得更糟。 接下來會發生的情況是，發佈伺服器會收到更多負載，因為它必須分別重新呈現每個Dispatcher的頁面。

![在頻繁發生快取清除的向外擴充案例中效能下降。](assets/chapter-2/decreased-performance.png)

*在頻繁發生快取清除的向外擴充案例中效能下降。*

<br> 

#### 緩解過度擴充的問題

您可以考慮對所有Dispatcher使用中央共用儲存空間，或同步Apache伺服器的檔案系統來緩解問題。 我們只能提供有限的第一手經驗，但請做好準備，這會增加系統的複雜性，並可能引入全新的錯誤類別。

我們曾經嘗試過NFS — 但是NFS由於內容鎖定而帶來了巨大的效能問題。 這實際上會降低整體效能。

**結論**  — 不建議在多個傳送器之間共用通用檔案系統。

如果您遇到效能問題，請平均放大Publish和Dispatcher以避免在Publisher執行個體上達到尖峰。 發佈/Dispatcher比率並無最佳規則，但高度取決於請求的分佈以及發佈和快取失效的頻率。

如果您也擔心訪客體驗的延遲，請考慮使用內容傳遞網路、快取重新擷取、先佔式快取預熱、設定寬限時間，如所述 [第1章](chapter-1.md) 或參考以下的一些進階概念： [第3部分](chapter-3.md).

### 「交叉連線」設定

我們偶爾會看到的另一個設定是「交叉連線」設定： Publish執行個體沒有專用的Dispatcher，但所有Dispatcher都已連線到所有Publish系統。

![跨連線拓撲：增加備援與複雜性](assets/chapter-2/cross-connected-setup.png)

<br> 

*跨連線拓撲：增加備援與複雜性。*

乍一看，這可提供更多備援，以應付相對較小的預算。 當其中一個Apache伺服器故障時，您仍然可以有兩個發佈系統來執行轉譯工作。 此外，如果其中一個Publish系統當機，您仍有兩個Dispatcher提供快取載入。

但這需要付出代價。

首先，取出一條腿進行維護相當麻煩。 事實上，這就是此方案的目的；提供更強韌性，並盡一切可能維持運作。 我們已經看過複雜的維護計畫，瞭解如何處理這個問題。 請先重新設定Dispatcher 2，並移除交叉連線。 重新啟動Dispatcher 2。 正在關閉Dispatcher 1、更新Publish 1、...等等。 如果您要調整到超過兩條腿，您應該仔細考慮。 您會得出結論，這實際上會增加複雜性和成本，並且是造成人為錯誤的強大來源。 最好將此自動化。 因此，如果您確實有人力資源在專案排程中加入此自動化任務，最好檢查一下。 雖然您可以藉此節省一些硬體成本，但您可能會花費雙倍的IT人員。

其次，您可能在AEM上執行一些需要登入的使用者應用程式。 您會使用粘性工作階段，以確保始終會從相同的AEM執行個體提供一個使用者，以便您可以維護該執行個體的工作階段狀態。 進行此交叉連線設定時，您必須確定粘性工作階段在負載平衡器和Dispatcher上正常運作。 並非不可能 — 但您需要注意這一點，並增加一些額外的設定和測試時間，這同樣可以節省硬體以節省您規劃的成本。

### 結論

我們不建議您使用此跨連線配置作為預設選項。 但是，如果您決定使用它，則需要仔細評估風險與隱藏成本，並規劃將設定自動化納入您的專案中。

## 下一步

* [3 — 進階快取主題](chapter-3.md)
