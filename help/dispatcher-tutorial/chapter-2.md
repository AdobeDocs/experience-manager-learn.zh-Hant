---
title: 第2章——定義事件內容片段模型
seo-title: AEM Content Services快速入門——第2章——定義事件內容片段模型
description: AEM無頭教學課程的第2章涵蓋啟用和定義內容片段模型，用於定義標準化的資料結構和製作介面以建立事件。
seo-description: AEM無頭教學課程的第2章涵蓋啟用和定義內容片段模型，用於定義標準化的資料結構和製作介面以建立事件。
translation-type: tm+mt
source-git-commit: e99779b5d42bb9a3b258e2bbe815defde9d40bf7
workflow-type: tm+mt
source-wordcount: '1917'
ht-degree: 0%

---


# 第2章——基礎設施

## 設定快取基礎結構

在本系列第1章中，我們介紹了Publish系統和調度器的基本拓撲。 一組Publish和Dispatcher伺服器可以配置成多種變化——具體取決於預期的負載、資料中心的拓撲和所需的故障切換屬性。

我們將描繪最常見的拓撲，並說明其優勢和不足之處。 當然，這份清單永遠不可能全面。 唯一的限制是你的想像力。

### 「舊版」設定

在早期，潛在訪客的數量很少，硬體成本很高，而且Web伺服器不像現在那樣被視為業務關鍵。 常見的設定是，在兩個或兩個以上的發佈系統前面設定一個Dispatcher作為負載平衡器和快取。 Dispatcher核心的Apache伺服器非常穩定，而且在大多數設定中，能夠提供相當數量的請求。

![「舊版」Dispatcher設定——按照當今標準，不太常見](assets/chapter-2/legacy-dispatcher-setup.png)

*「舊版」Dispatcher設定——按照當今標準，不太常見*

<br> 

This is here the dispatcher received its name from:它基本上是在發送請求。 由於無法滿足當今對效能和穩定性的更高要求，此設定不再非常常見。

### 多腿設定

現在，稍微不同的拓撲更常見。 多條腿的拓撲將具有一個Dispatcher per Publish伺服器。 專用（硬體）負載平衡器位於AEM基礎架構前面，將要求分派給這兩條（或多條）腿：

![現代「標準」Dispatcher設定——易於處理和維護](assets/chapter-2/modern-standard-dispatcher-setup.png)

*現代「標準」Dispatcher設定——易於處理和維護*

<br> 

這種設定的原因如下，

1. 平均而言，網站提供的流量比過去多得多。 因此，有必要擴大&quot;阿帕奇基礎設施&quot;。

2. 「舊版」設定在Dispatcher級別上未提供冗餘。 如果Apache Server關閉，則無法訪問整個網站。

3. Apache Servers價格低廉。 它們基於開放原始碼，而且，由於您有虛擬資料中心，因此可以非常快地進行資源調配。

4. 此設定提供「滾動」或「交錯」更新藍本的簡單方式。 您只需在Publish 1上安裝新的軟體包時關閉Dispatcher 1即可。 當安裝完成，而且您已從內部網路對Publish 1進行充分的煙霧測試後，請清除Dispatcher 1上的快取，並重新啟動它，同時取下Dispatcher 2以維護Publish 2。

5. 在此設定中，快取失效變得非常容易且是確定性的。 由於只有一個Publish系統連接到一個Dispatcher，因此只有一個Dispatcher可以失效。 失效的順序和時間無關緊要。

### 「向外擴展」設定

Apache伺服器不但便宜而且易於布建，為什麼不進一步推廣此層級。 為什麼每個發佈伺服器前面沒有兩個或多個調度程式？

![「橫向擴展」設定——有一些應用程式領域，但也有限制和注意事項](assets/chapter-2/scale-out-setup.png)

*「橫向擴展」設定——有一些應用程式領域，但也有限制和注意事項*

<br> 

你絕對能做到！ 此設定有許多有效的應用程式藍本。 但您也應考慮到一些限制和複雜性。

#### 失效

每個發佈系統都連接到多個調度程式，每個調度程式在內容更改時必須失效。

#### 維護

不言而喻，Dispatcher和Publish系統的初始配置要複雜一些。 但請記住，「滾動」版本的努力也要高一些。 AEM系統可在執行時更新，而且必須更新。 但明智的做法是，在它們積極滿足請求的同時，不要這樣做。 通常，您只想要更新Publish系統的一部分——而其他系統仍會主動提供流量，然後在測試後，切換至另一部分。 如果您很幸運，而且可以在部署過程中訪問負載平衡器，則可以在此處禁用要維護的伺服器的路由。 如果您使用的是沒有直接存取的共用負載平衡器，您寧可關閉您要更新之發佈的調度程式。 越多，你就越需要關閉。 如果有大量使用者，而您正規劃頻繁更新，建議您自動化。 如果您沒有自動化工具，放大規模是個壞主意。

在過去的專案中，我們使用不同的技巧從負載平衡中移除發佈系統，而無須直接存取負載平衡器本身。

負載平衡器通常是「ping」，這是查看伺服器是否啟動和運行的特定頁。 一般而言，Ping首頁是個瑣碎的選擇。 但是，如果您想使用ping來向負載平衡器發出信號，而不是平衡流量，您會選擇其他方法。 您可以建立專用的範本或servlet，其可設定為 `"up"` 以或 `"down"` （在內文中或以http回應程式碼）回應。 當然，該頁面的回應不得快取到發送器中，因此一律會從Publish系統中新擷取。 現在，如果您設定負載平衡器來檢查此範本或servlet，您就可輕鬆讓Publish 「假裝」關閉。 它將不是負載平衡的一部分，而且可以更新。

#### 全球散發

「全球散發」是「橫向擴充」的設定，您在每個發佈系統前都有多個調度程式——現在散布至世界各地，以便更貼近客戶並提供更佳的效能。 當然，在這種情況下，您沒有中央負載平衡器，而是採用DNS和地理IP的負載平衡方案。

>[!NOTE]
>
>事實上，您正在使用此方法建立內容分發網路(CDN)，因此您應考慮購買現成的CDN解決方案，而不是自行建立。 建立和維護自訂CDN並非易事。

#### 水準縮放

即使在本地資料中心，「向外擴展」拓撲在每個發佈系統前面有多個調度程式，這種拓撲也具有一些優勢。 如果您發現Apache伺服器上的效能瓶頸是由於高流量（以及良好的快取點擊率），而且無法再擴充硬體（透過新增CPU、RAM和更快速的磁碟），則可新增「調度程式」來提升效能。 這稱為「水準縮放」。 但是，這有其限制——尤其是當您經常使流量無效時。 我們將在下一節中說明效果。

#### 向外擴展拓撲的限制

添加代理伺服器通常應提高效能。 但是，有些情況下，添加伺服器實際上會降低效能。 怎麼做？ 假設您有新聞入口網站，每分鐘都會在這裡介紹新文章和頁面。 Dispatcher因「自動失效」而失效：每當發佈頁面時，相同網站上快取中的所有頁面都會失效。 這是一項有用的功能——本系列第1章中將此內容介紹給您——但也意味著，當您的網站經常發生變更時，您會經常使快取失效。 [](chapter-1.md) 如果每個Publish實例只有一個Dispatcher，則請求頁面的第一個訪客會觸發該頁面的重新快取。 第二個訪客已取得快取版本。

如果您有兩個「調度程式」，第二個訪客有50%的機會未快取頁面，然後當再次轉譯該頁面時，他會遇到較大的延遲。 每次發佈擁有更多調度程式會讓情況更糟。 發生的情況是，發佈伺服器會收到更多負載，因為它必須分別重新呈現每個Dispatcher的頁面。

![在頻繁快取刷新的橫向擴展場景中降低了效能。](assets/chapter-2/decreased-performance.png)

*在頻繁快取刷新的橫向擴展場景中降低了效能。*

<br> 

#### 減輕過度縮放問題

您可考慮為所有調度程式使用集中共用儲存，或同步Apache伺服器的檔案系統以緩解問題。 我們只能提供有限的第一手經驗，但要準備好，這會增加系統的複雜性，並引入全新的錯誤類別。

我們在NFS上做了一些實驗，但NFS由於內容鎖定而帶來了巨大的效能問題。 這實際上降低了整體效能。

**結論** -建議在多個調度程式之間共用通用檔案系統。

如果您遇到效能問題，請平等地放大「發佈」和「調度程式」，以避免「發佈程式」執行個體的高峰負載。 Publish/Dispatcher比率沒有黃金規則——它高度取決於請求的分佈以及發佈和快取失效的頻率。

如果您也擔心訪客體驗的延遲，請考慮使用內容傳送網路、快取重新取回、搶佔式快取預熱、設定寬限時間（如本系列第1章所述），或參考 [第3部份的進階構想](chapter-1.md)[](chapter-3.md)。

### 「交叉連接」設定

另一個我們現在常見的設定是「交叉連線」設定：發佈實例沒有專用的調度程式，但所有調度程式都連接到所有的發佈系統。

![交叉連接的拓撲：增加冗餘性和更複雜性](assets/chapter-2/cross-connected-setup.png)

<br> 

*交叉連接的拓撲：增加冗餘性和複雜性。*

乍一看，這為相對較小的預算提供了一些更多冗餘。 當其中一個Apache伺服器關閉時，您仍然可以有兩個Publish系統來執行轉換工作。 此外，如果其中一個Publish系統當機，您仍有兩個Dispatcher來支援快取的載入。

然而，這是有代價的。

首先，取掉一條腿進行維修相當麻煩。 實際上，這就是這個計畫的目的。以便更有彈性，並且盡一切可能保持運行。 我們已看到如何處理此問題的複雜維護計畫。 首先重新配置Dispatcher 2，刪除交叉連接。 重新啟動Dispatcher 2。 正在關閉Dispatcher 1、更新Publish 1、...等。 如果這個長度可以擴展到兩條以上，您應當仔細考慮。 你會得出結論，它實際上增加了複雜性，增加了成本，是人類錯誤的可怕來源。 最好是自動化。 因此，最好檢查一下，如果您真的有人力資源，將這項自動化工作納入您的專案排程。 雖然您可以通過此方式節省一些硬體成本，但您可以在IT人員上花費兩倍。

其次，您可能會在需要登入的AEM上執行某些使用者應用程式。 您會使用嚴格作業，以確保始終有一個使用者從相同的AEM例項獲得服務，如此您就可以維護該例項的作業狀態。 通過此交叉連接的設定，您必須確保在負載平衡器和調度程式上的粘滯會話工作正常。 並非不可能，但您需要注意到這一點，並增加一些額外的配置和測試時間，這樣，您節省硬體成本的成本可能也會隨之增加。

### 結論

我們不建議您將此交叉連接方案用作預設選項。 但是，如果您決定使用它，您將需要仔細評估風險和隱藏成本，並計畫將配置自動化納入項目。

## 下一步

* [3 —— 進階快取主題](chapter-3.md)
